<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Generator - GrassRoots</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container container">
            <a href="dashboard.html" class="logo">GrassRoots</a>
            <div class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="contact.html">Contact</a>
                <a href="login.html">Logout</a>
            </div>
        </div>
    </nav>

    <main class="container" style="padding:2.5rem 0;">
        <div class="form-container" style="max-width: 980px; margin:96px auto 40px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;">
                <h2 style="color:var(--primary-color);font-size:1.15rem;margin:0;display:flex;align-items:center;gap:0.6rem;">ðŸ“± Generate QR Code for Product</h2>
                <div style="color:var(--muted);font-size:0.95rem;opacity:0.9">Create codes buyers can scan</div>
            </div>

            <form id="qrForm">
                <div class="form-group">
                    <label for="productName">Product Name</label>
                    <input type="text" id="productName" placeholder="e.g., Organic Rice Batch 001" required>
                </div>
                <div class="form-group">
                    <label for="productInfo">Product Information</label>
                    <textarea id="productInfo" rows="3" placeholder="Details: variety, harvest date, location, certifications, etc." required></textarea>
                </div>
                <button type="submit" class="btn" style="width:100%;">Generate QR Code</button>
            </form>

            <div class="qr-container" style="text-align:center;margin-top:1.25rem;">
                <div id="qrcode"></div>
                <button id="downloadBtn" class="btn" style="display: none; margin-top: 1rem;">Download QR Code</button>
            </div>
        </div>
    </main>

    <script>
        // Auth guard: allow only logged-in farmers to access this page
        (function() {
            const loggedIn = localStorage.getItem('loggedIn');
            const userType = localStorage.getItem('userType');
            if (loggedIn !== 'true' || userType !== 'farmer') {
                alert('Access denied: This page is for farmers only.');
                window.location.href = 'login.html';
            }
        })();

        document.getElementById('qrForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const productName = document.getElementById('productName').value;
            const productInfo = document.getElementById('productInfo').value;
            const qrData = `GrassRoots|${productName}|${productInfo}|Farmer:${localStorage.getItem('userEmail')}`;

            document.getElementById('qrcode').innerHTML = '';
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '<p>Generating QR Code...</p>';

            setTimeout(() => {
                qrContainer.innerHTML = '';
                // Using qrcode library included in this page
                QRCode.toCanvas(document.createElement('canvas'), qrData, function (error, canvas) {
                    if (error) { console.error(error); qrContainer.innerHTML = '<p style="color:#c00">Error generating QR</p>'; return; }
                    qrContainer.appendChild(canvas);
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                });
            }, 250);
        });

        document.getElementById('downloadBtn').addEventListener('click', function() {
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) return;
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.download = 'product-qr-code.png';
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        function generateBatchId() {
            return 'BATCH-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }
    </script>
</body>
</html>