<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Generator - GrassRoots</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="js/auth.js" defer></script>
    <script src="js/utils.js" defer></script>
    <style>
        .qr-section { margin-bottom: 2rem; padding: 1rem; background: #f9f9f9; border-radius: 0.5rem; border: 1px solid #e0e0e0; }
        .qr-section h3 { margin-top: 0; color: var(--primary-color); font-size: 1rem; }
        .qr-history { max-height: 400px; overflow-y: auto; margin-top: 1rem; }
        .qr-item { display: flex; align-items: center; padding: 0.75rem; background: white; margin: 0.5rem 0; border-radius: 0.35rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .qr-item-preview { width: 60px; height: 60px; margin-right: 1rem; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; }
        .qr-item-preview canvas { max-width: 100%; max-height: 100%; }
        .qr-item-info { flex: 1; }
        .qr-item-name { font-weight: 600; color: var(--text-color); font-size: 0.95rem; }
        .qr-item-detail { font-size: 0.85rem; color: var(--muted); margin: 0.25rem 0; }
        .qr-item-actions { display: flex; gap: 0.5rem; }
        .qr-item-actions button { padding: 0.4rem 0.8rem; font-size: 0.8rem; background: #2f6b50; color: white; border: none; border-radius: 0.25rem; cursor: pointer; }
        .qr-item-actions button:hover { background: #1f4d35; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container container">
            <a href="farmer-dashboard.html" class="logo">GrassRoots</a>
            <div class="nav-links">
                <a href="farmer-dashboard.html">Dashboard</a>
                <a href="contact.html">Contact</a>
            </div>
        </div>
    </nav>

    <main class="container" style="padding: 2.5rem 0; min-height: 100vh;">
        <div class="form-container" style="max-width: 980px; margin: 96px auto 40px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                <h2 style="color: var(--primary-color); font-size: 1.15rem; margin: 0; display: flex; align-items: center; gap: 0.6rem;">ðŸ“± QR Code Generator</h2>
                <div style="color: var(--muted); font-size: 0.95rem; opacity: 0.9;">Generate QR codes from your crop data</div>
            </div>

            <!-- Crop Selection -->
            <div class="qr-section">
                <h3>Step 1: Select Your Crop</h3>
                <div class="form-group">
                    <label for="cropSelect">Choose a Saved Crop (or manually enter below)</label>
                    <select id="cropSelect">
                        <option value="">-- Select a crop --</option>
                    </select>
                </div>
            </div>

            <!-- QR Generation Form -->
            <form id="qrForm" class="qr-section">
                <h3>Step 2: Enter Product & Agricultural Details</h3>

                <div class="form-group">
                    <label for="productName">Product Name</label>
                    <input id="productName" type="text" placeholder="e.g. Cherry Tomatoes" />
                </div>

                <div class="form-group">
                    <label for="cropType">Crop Type</label>
                    <input id="cropType" type="text" placeholder="e.g. Tomato" />
                </div>

                <div class="form-group">
                    <label for="quality">Quality</label>
                    <input id="quality" type="text" placeholder="e.g. Grade A" />
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1; margin-right:0.5rem;">
                        <label for="harvestDate">Harvest Date</label>
                        <input id="harvestDate" type="date" />
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="price">Price (optional)</label>
                        <input id="price" type="number" step="0.01" placeholder="0.00" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="farmLocation">Farm Location</label>
                    <input id="farmLocation" type="text" placeholder="e.g. Village, District" />
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1; margin-right:0.5rem;">
                        <label for="fertilizerUsed">Fertilizer Used</label>
                        <input id="fertilizerUsed" type="text" />
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="pesticidesUsed">Pesticides Used</label>
                        <input id="pesticidesUsed" type="text" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1; margin-right:0.5rem;">
                        <label for="batchNumber">Batch Number</label>
                        <input id="batchNumber" type="text" />
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>&nbsp;</label>
                        <button type="submit" style="width:100%;">Generate QR</button>
                    </div>
                </div>

                <div id="qrDisplaySection" style="display:none; margin-top:1rem;">
                    <div id="qrcode"></div>
                    <div id="qrStatus" style="margin-top:0.5rem; color:var(--muted); font-size:0.95rem;"></div>
                    <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                        <button id="downloadBtn" type="button">Download</button>
                        <button id="printBtn" type="button">Print</button>
                    </div>
                </div>

                <div id="qrHistorySection" style="display:none; margin-top:1rem;">
                    <h4>QR History</h4>
                    <div id="qrHistory" class="qr-history"></div>
                </div>
            </form>

    <script>
            const data = {
                productName: document.getElementById('productName').value,
                cropType: document.getElementById('cropType').value,
                quality: document.getElementById('quality').value,
                harvestDate: document.getElementById('harvestDate').value,
                farmLocation: document.getElementById('farmLocation').value,
                fertilizerUsed: document.getElementById('fertilizerUsed').value,
                pesticidesUsed: document.getElementById('pesticidesUsed').value,
                batchNumber: document.getElementById('batchNumber').value,
                price: document.getElementById('price').value,
                farmerEmail: localStorage.getItem('userEmail'),
                farmerName: localStorage.getItem('fullName'),
                generatedAt: new Date().toISOString()
            };

            // Format as human-readable text block
            let qrText = `GrassRoots QR\n`;
            qrText += `Product: ${data.productName}\n`;
            qrText += `Type: ${data.cropType}\n`;
            qrText += `Quality: ${data.quality}\n`;
            qrText += `Harvest: ${data.harvestDate}\n`;
            qrText += `Location: ${data.farmLocation}\n`;
            qrText += `Fertilizer: ${data.fertilizerUsed}\n`;
            qrText += `Pesticides: ${data.pesticidesUsed}\n`;
            if (data.batchNumber) qrText += `Batch: ${data.batchNumber}\n`;
            if (data.price) qrText += `Price: ${data.price}\n`;
            qrText += `Farmer: ${data.farmerName}\n`;
            qrText += `Contact: ${data.farmerEmail}\n`;
            qrText += `Generated: ${new Date().toLocaleString()}`;

            return { qrText, data };
        }

        // Generate QR Code
        document.getElementById('qrForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const { qrText, data } = formatQRData();

            document.getElementById('qrcode').innerHTML = '';
            document.getElementById('qrDisplaySection').style.display = 'block';
            document.getElementById('qrHistorySection').style.display = 'block';

            // Generate QR: try local QR library first, then fallback to qrserver API
            async function renderCanvasFromImage(imgSrc) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas);
                    };
                    img.onerror = (e) => reject(e || new Error('Image load error'));
                    img.src = imgSrc;
                });
            }

            async function generateAndSaveQRCode(qrText, data) {
                // Try server-side generation first (most reliable for CORS-free PNG)
                try {
                    const payload = Object.assign({}, data, { text: qrText });
                    const resp = await GrassRootsUtils.apiFetch('/api/qr/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (resp) {
                        console.debug('Server /api/qr/generate response:', resp);
                    }
                    if (resp && resp.ok) {
                        const json = await resp.json();
                        console.debug('Server /api/qr/generate JSON:', json && (json.dataUrl ? '[dataUrl present]' : json));
                        const dataUrl = json.dataUrl || (json.record && json.record.canvasData) || null;
                        // Render returned dataUrl
                        document.getElementById('qrcode').innerHTML = '';
                        if (dataUrl) {
                            try {
                                const img = new Image();
                                img.onload = () => {
                                    // draw to canvas for consistent UI and to allow download/print as canvas
                                    const canvas = document.createElement('canvas');
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0);
                                    document.getElementById('qrcode').appendChild(canvas);
                                };
                                img.onerror = () => {
                                    // fallback: show image element
                                    const fallbackImg = document.createElement('img');
                                    fallbackImg.src = dataUrl;
                                    fallbackImg.style.maxWidth = '300px';
                                    document.getElementById('qrcode').appendChild(fallbackImg);
                                };
                                img.src = dataUrl;
                                // update status when image load starts
                                const st = document.getElementById('qrStatus'); if (st) st.innerText = 'Generated by server';
                            } catch (renderErr) {
                                console.warn('Rendering dataUrl failed, showing as image instead', renderErr);
                                const img = document.createElement('img');
                                img.src = dataUrl;
                                img.style.maxWidth = '300px';
                                document.getElementById('qrcode').appendChild(img);
                            }
                        } else {
                            document.getElementById('qrcode').innerHTML = '<p style="color:#c00;">Server generated QR but no image returned</p>';
                            const st = document.getElementById('qrStatus'); if (st) st.innerText = 'Server returned no image';
                        }

                        // Persisted on server; also update local history view
                        try {
                            const record = json.record || {
                                id: 'qr_' + Date.now(),
                                qrText,
                                ...data,
                                canvasData: dataUrl || null,
                                generatedAt: new Date().toISOString()
                            };
                            // Save locally for quick access
                            let qrHistory = JSON.parse(localStorage.getItem('farmer_qr_codes') || '[]');
                            qrHistory.unshift(record);
                            qrHistory = qrHistory.slice(0, 20);
                            localStorage.setItem('farmer_qr_codes', JSON.stringify(qrHistory));
                        } catch (localErr) {
                            console.warn('Failed to update local history:', localErr);
                        }

                        return true;
                    }
                } catch (serverErr) {
                    console.warn('Server-side QR generation failed, falling back to client/remote:', serverErr && serverErr.message ? serverErr.message : serverErr);
                    // fall through to existing client-side / remote fallback below
                }

                // Existing client-side / remote fallback
                let canvas = null;
                // Try local library
                try {
                    if (typeof QRCode !== 'undefined' && typeof QRCode.toCanvas === 'function') {
                        canvas = document.createElement('canvas');
                        await new Promise((res, rej) => {
                            QRCode.toCanvas(canvas, qrText, { width: 300, margin: 2 }, (err) => err ? rej(err) : res());
                        });
                    } else if (typeof qrcode !== 'undefined' && typeof qrcode.toCanvas === 'function') {
                        canvas = document.createElement('canvas');
                        await new Promise((res, rej) => {
                            qrcode.toCanvas(canvas, qrText, { width: 300, margin: 2 }, (err) => err ? rej(err) : res());
                        });
                    } else {
                        throw new Error('QR library not available');
                    }
                } catch (err) {
                    console.warn('Local QR generation failed, falling back to remote API:', err && err.message ? err.message : err);
                    // Fallback to external QR image service
                    try {
                        const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(qrText);
                        canvas = await renderCanvasFromImage(apiUrl);
                    } catch (err2) {
                        console.error('Remote QR fallback failed:', err2);
                        document.getElementById('qrcode').innerHTML = '<p style="color:#c00;">Error generating QR code</p>';
                        return null;
                    }
                }

                // Append canvas to UI (or image fallback)
                document.getElementById('qrcode').innerHTML = '';
                if (canvas) {
                    document.getElementById('qrcode').appendChild(canvas);
                    const st = document.getElementById('qrStatus'); if (st) st.innerText = 'Generated locally';
                } else {
                    // show remote image as fallback
                    const img = document.createElement('img');
                    const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(qrText);
                    img.src = apiUrl;
                    img.alt = 'QR code';
                    img.style.maxWidth = '300px';
                    document.getElementById('qrcode').appendChild(img);
                    const st = document.getElementById('qrStatus'); if (st) st.innerText = 'Generated via remote API fallback';
                }

                // Save to history record
                const qrId = 'qr_' + Date.now();
                const selectedCrop = document.getElementById('cropSelect').value || null;
                const qrRecord = {
                    id: qrId,
                    cropId: selectedCrop,
                    ...data,
                    qrText: qrText,
                    // attempt to include canvasData if available (may fail due to cross-origin)
                    canvasData: (function(){
                        try {
                            return canvas ? canvas.toDataURL('image/png') : null;
                        } catch (e) {
                            console.warn('Could not generate canvas dataURL:', e);
                            return null;
                        }
                    })()
                };

                // POST to backend API
                try {
                    const resp = await GrassRootsUtils.apiFetch('/api/qr', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(qrRecord)
                    });
                    if (!resp.ok) throw new Error('Failed to save QR');
                } catch (err) {
                    console.error('Failed to save QR to server:', err);
                    GrassRootsUtils.showToast('Saved locally but server save failed', 'error');
                    // fallback: save locally so user doesn't lose data
                    let qrHistory = JSON.parse(localStorage.getItem('farmer_qr_codes') || '[]');
                    qrHistory.unshift(qrRecord);
                    qrHistory = qrHistory.slice(0, 10);
                    localStorage.setItem('farmer_qr_codes', JSON.stringify(qrHistory));
                }

                return true;
            }

            // Run generation
            await generateAndSaveQRCode(qrText, data);

            // Refresh history
            renderQRHistory();
        });

        // Download QR
        document.getElementById('downloadBtn').addEventListener('click', function() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const url = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.download = `QR-${document.getElementById('productName').value || 'product'}-${Date.now()}.png`;
                a.href = url;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                return;
            }
            // fallback to image src
            const img = document.querySelector('#qrcode img');
            if (!img || !img.src) return;
            fetch(img.src).then(r => r.blob()).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.download = `QR-${document.getElementById('productName').value || 'product'}-${Date.now()}.png`;
                a.href = url;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }).catch(err => console.error('Download fallback failed', err));
        });

        // Print QR
        document.getElementById('printBtn').addEventListener('click', function() {
            const canvas = document.querySelector('#qrcode canvas');
            const productName = document.getElementById('productName').value;
            const printWindow = window.open('', '', 'width=800,height=600');
            if (canvas) {
                printWindow.document.write(`
                    <html><head><title>Print QR Code</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
                        h2 { color: #2f6b50; }
                        img { max-width: 400px; margin: 1rem 0; border: 1px solid #ddd; padding: 0.5rem; }
                        .details { text-align: left; max-width: 600px; margin: 1rem auto; font-size: 0.9rem; }
                    </style>
                    </head><body>
                    <h2>${productName}</h2>
                    <img src="${canvas.toDataURL('image/png')}" />
                    <div class="details">
                        <p><strong>Crop Type:</strong> ${document.getElementById('cropType').value}</p>
                        <p><strong>Quality:</strong> ${document.getElementById('quality').value}</p>
                        <p><strong>Harvest Date:</strong> ${document.getElementById('harvestDate').value}</p>
                        <p><strong>Fertilizer:</strong> ${document.getElementById('fertilizerUsed').value}</p>
                        <p><strong>Pesticides:</strong> ${document.getElementById('pesticidesUsed').value}</p>
                    </div>
                `);
                printWindow.document.close();
                printWindow.print();
                return;
            }
            // fallback to image
            const img = document.querySelector('#qrcode img');
            if (!img) return;
            printWindow.document.write(`
                <html><head><title>Print QR Code</title>
                <style>
                    body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
                    h2 { color: #2f6b50; }
                    img { max-width: 400px; margin: 1rem 0; border: 1px solid #ddd; padding: 0.5rem; }
                    .details { text-align: left; max-width: 600px; margin: 1rem auto; font-size: 0.9rem; }
                </style>
                </head><body>
                <h2>${productName}</h2>
                <img src="${img.src}" />
                <div class="details">
                    <p><strong>Crop Type:</strong> ${document.getElementById('cropType').value}</p>
                    <p><strong>Quality:</strong> ${document.getElementById('quality').value}</p>
                    <p><strong>Location:</strong> ${document.getElementById('farmLocation').value}</p>
                    <p><strong>Fertilizer:</strong> ${document.getElementById('fertilizerUsed').value}</p>
                    <p><strong>Pesticides:</strong> ${document.getElementById('pesticidesUsed').value}</p>
                </div>
            `);
            printWindow.document.close();
            printWindow.print();
        });

        // Render QR History (fetch from backend)
        async function renderQRHistory() {
            const historyDiv = document.getElementById('qrHistory');
                try {
                const resp = await GrassRootsUtils.apiFetch('/api/qr');
                if (!resp.ok) throw new Error('Failed to load');
                const qrHistory = await resp.json();

                if (!qrHistory || qrHistory.length === 0) {
                    historyDiv.innerHTML = '<p style="color: var(--muted);">No QR codes generated yet.</p>';
                    return;
                }

                let html = '';
                qrHistory.forEach(qr => {
                    html += `
                        <div class="qr-item">
                            <div class="qr-item-preview" id="preview-${qr.id}"></div>
                            <div class="qr-item-info">
                                <div class="qr-item-name">${GrassRootsUtils.sanitizeHTML(qr.productName)}</div>
                                <div class="qr-item-detail">Crop: ${GrassRootsUtils.sanitizeHTML(qr.cropType)} | Quality: ${GrassRootsUtils.sanitizeHTML(qr.quality)}</div>
                                <div class="qr-item-detail">Harvest: ${GrassRootsUtils.sanitizeHTML(qr.harvestDate)} | Generated: ${new Date(qr.generatedAt).toLocaleDateString()}</div>
                            </div>
                            <div class="qr-item-actions">
                                <button onclick="downloadQRFromHistory('${qr.id}')">Download</button>
                                <button onclick="printQRFromHistory('${qr.id}')">Print</button>
                            </div>
                        </div>
                    `;
                });
                historyDiv.innerHTML = html;

                // Render preview images
                qrHistory.forEach(qr => {
                    const previewDiv = document.getElementById(`preview-${qr.id}`);
                    if (previewDiv && qr.canvasData) {
                        const img = document.createElement('img');
                        img.src = qr.canvasData;
                        img.style.maxWidth = '100%';
                        previewDiv.appendChild(img);
                    }
                });
            } catch (err) {
                console.error('Failed to load QR history:', err);
                // Fallback to localStorage for older records
                const qrHistory = JSON.parse(localStorage.getItem('farmer_qr_codes') || '[]');
                if (!qrHistory.length) {
                    historyDiv.innerHTML = '<p style="color: var(--muted);">No QR codes generated yet.</p>';
                    return;
                }
                let html = '';
                qrHistory.forEach(qr => {
                    html += `
                        <div class="qr-item">
                            <div class="qr-item-preview" id="preview-${qr.id}"></div>
                            <div class="qr-item-info">
                                <div class="qr-item-name">${GrassRootsUtils.sanitizeHTML(qr.productName)}</div>
                                <div class="qr-item-detail">Crop: ${GrassRootsUtils.sanitizeHTML(qr.cropType)} | Quality: ${GrassRootsUtils.sanitizeHTML(qr.quality)}</div>
                                <div class="qr-item-detail">Harvest: ${GrassRootsUtils.sanitizeHTML(qr.harvestDate)} | Generated: ${new Date(qr.generatedAt).toLocaleDateString()}</div>
                            </div>
                            <div class="qr-item-actions">
                                <button onclick="downloadQRFromHistory('${qr.id}')">Download</button>
                                <button onclick="printQRFromHistory('${qr.id}')">Print</button>
                            </div>
                        </div>
                    `;
                });
                historyDiv.innerHTML = html;
                qrHistory.forEach(qr => {
                    const previewDiv = document.getElementById(`preview-${qr.id}`);
                    if (previewDiv && qr.canvasData) {
                        const img = document.createElement('img');
                        img.src = qr.canvasData;
                        img.style.maxWidth = '100%';
                        previewDiv.appendChild(img);
                    }
                });
            }
        }

        // Download from history
        window.downloadQRFromHistory = function(qrId) {
            const qrHistory = JSON.parse(localStorage.getItem('farmer_qr_codes') || '[]');
            const qr = qrHistory.find(q => q.id === qrId);
            if (!qr) return;
            if (qr.canvasData) {
                const a = document.createElement('a');
                a.href = qr.canvasData;
                a.download = `QR-${qr.productName}-${qr.id}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                return;
            }
            // fallback to remote image
            const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(qr.qrText || qr.productName || qr.id);
            fetch(apiUrl).then(r => r.blob()).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `QR-${qr.productName || qr.id}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }).catch(err => console.error('Download history fallback failed', err));
        };

        // Print from history
        window.printQRFromHistory = function(qrId) {
            const qrHistory = JSON.parse(localStorage.getItem('farmer_qr_codes') || '[]');
            const qr = qrHistory.find(q => q.id === qrId);
            if (!qr) return;
            const printWindow = window.open('', '', 'width=800,height=600');
            if (qr.canvasData) {
                printWindow.document.write(`
                    <html><head><title>Print QR Code</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
                        h2 { color: #2f6b50; }
                        img { max-width: 400px; margin: 1rem 0; border: 1px solid #ddd; padding: 0.5rem; }
                        .details { text-align: left; max-width: 600px; margin: 1rem auto; font-size: 0.9rem; }
                    </style>
                    </head><body>
                    <h2>${qr.productName}</h2>
                    <img src="${qr.canvasData}" />
                    <div class="details">
                        <p><strong>Crop Type:</strong> ${qr.cropType}</p>
                        <p><strong>Quality:</strong> ${qr.quality}</p>
                        <p><strong>Location:</strong> ${qr.farmLocation}</p>
                        <p><strong>Fertilizer:</strong> ${qr.fertilizerUsed}</p>
                        <p><strong>Pesticides:</strong> ${qr.pesticidesUsed}</p>
                        <p><strong>Farmer:</strong> ${qr.farmerName} (${qr.farmerEmail})</p>
                    </div>
                `);
                printWindow.document.close();
                printWindow.print();
                return;
            }
            // fallback to remote image
            const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(qr.qrText || qr.productName || qr.id);
            printWindow.document.write(`
                <html><head><title>Print QR Code</title>
                <style>
                    body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
                    h2 { color: #2f6b50; }
                    img { max-width: 400px; margin: 1rem 0; border: 1px solid #ddd; padding: 0.5rem; }
                    .details { text-align: left; max-width: 600px; margin: 1rem auto; font-size: 0.9rem; }
                </style>
                </head><body>
                <h2>${qr.productName}</h2>
                <img src="${apiUrl}" />
                <div class="details">
                    <p><strong>Crop Type:</strong> ${qr.cropType}</p>
                    <p><strong>Quality:</strong> ${qr.quality}</p>
                    <p><strong>Location:</strong> ${qr.farmLocation}</p>
                    <p><strong>Fertilizer:</strong> ${qr.fertilizerUsed}</p>
                    <p><strong>Pesticides:</strong> ${qr.pesticidesUsed}</p>
                    <p><strong>Farmer:</strong> ${qr.farmerName} (${qr.farmerEmail})</p>
                </div>
            `);
            printWindow.document.close();
            printWindow.print();
        };

        // Initialize on page load
        window.addEventListener('load', function() {
            async function loadCropSelector() {
                const sel = document.getElementById('cropSelect');
                sel.innerHTML = '<option value="">-- Select a crop --</option>';
                try {
                    const resp = await GrassRootsUtils.apiFetch('/api/crops');
                    if (resp.ok) {
                        const crops = await resp.json();
                        crops.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c.id || c.id;
                            opt.text = c.name || c.productName || (c.cropType || c.type) || (`Crop ${c.id}`);
                            sel.appendChild(opt);
                        });
                    }
                } catch (err) {
                    // ignore and fallback to localStorage
                }

                // localStorage fallback
                try {
                    const local = JSON.parse(localStorage.getItem('farmerCrops') || '[]');
                    local.forEach(c => {
                        // don't duplicate options if already present
                        if (![...sel.options].some(o => o.value == c.id)) {
                            const opt = document.createElement('option');
                            opt.value = c.id;
                            opt.text = c.name || c.productName || (c.type || 'Crop');
                            sel.appendChild(opt);
                        }
                    });
                } catch (e) {
                    // ignore
                }

                sel.addEventListener('change', function() {
                    const crops = JSON.parse(localStorage.getItem('farmerCrops') || '[]');
                    // attempt to get from last fetched list via API if available
                    (async () => {
                        let list = crops;
                        try {
                            const resp = await GrassRootsUtils.apiFetch('/api/crops');
                            if (resp.ok) list = await resp.json();
                        } catch (e) {}

                        const selected = list.find(c => String(c.id) === String(this.value));
                        if (selected) {
                            document.getElementById('cropType').value = selected.cropType || selected.type || '';
                            document.getElementById('farmLocation').value = selected.notes || selected.farmLocation || '';
                        }
                    })();
                });

            
            }
            loadCropSelector();
            renderQRHistory();
        });

        // Global error handlers to capture uncaught errors/rejections during QR generation
        window.addEventListener('error', function (evt) {
            console.error('Global error captured:', evt.error || evt.message || evt);
            GrassRootsUtils.showToast('Unexpected error: ' + (evt.message || 'see console'), 'error');
        });

        window.addEventListener('unhandledrejection', function (evt) {
            console.error('Unhandled rejection:', evt.reason || evt);
            GrassRootsUtils.showToast('Unexpected error (promise): see console', 'error');
        });
    </script>
</body>
</html>