<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Crop Information - GrassRoots</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="js/auth.js" defer></script>
  <script src="js/utils.js" defer></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container container">
      <a href="index.html" class="logo">GrassRoots</a>
      <div class="nav-links">
        <a href="farmer-dashboard.html">Dashboard</a>
        <a href="contact.html">Contact</a>
      </div>
    </div>
  </nav>

  <main class="container" style="padding:2.5rem 0;">
    <div class="form-container" style="max-width:980px;margin:96px auto 40px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;">
        <h2 style="color:var(--primary-color);font-size:1.15rem;margin:0;display:flex;align-items:center;gap:0.6rem;">üçÉ Manage Your Crop Information</h2>
        <div style="color:var(--muted);font-size:0.95rem;opacity:0.9">&nbsp;</div>
      </div>

      <!-- Crop Information Form -->
      <form id="cropInfoFormLocal">
        <div class="form-group">
          <label for="cropTypeLocal">Crop Type</label>
          <select id="cropTypeLocal" required>
            <option value="">Select Crop</option>
            <optgroup label="Cereals">
              <option value="Rice">Rice</option>
              <option value="Wheat">Wheat</option>
              <option value="Maize">Maize (Corn)</option>
            </optgroup>
            <optgroup label="Cash Crops">
              <option value="Cotton">Cotton</option>
              <option value="Sugarcane">Sugarcane</option>
            </optgroup>
            <optgroup label="Vegetables">
              <option value="Tomato">Tomato</option>
              <option value="Potato">Potato</option>
              <option value="Onion">Onion</option>
              <option value="Cabbage">Cabbage</option>
              <option value="Carrot">Carrot</option>
              <option value="Beans">Beans</option>
            </optgroup>
            <optgroup label="Spices">
              <option value="Chili">Chili</option>
              <option value="Turmeric">Turmeric</option>
              <option value="Ginger">Ginger</option>
            </optgroup>
            <optgroup label="Fruits">
              <option value="Banana">Banana</option>
              <option value="Mango">Mango</option>
              <option value="Papaya">Papaya</option>
              <option value="Grapes">Grapes</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label for="plantingDateLocal">Planting Date</label>
          <input type="date" id="plantingDateLocal" required>
        </div>
        <div class="form-group">
          <label for="areaLocal">Area (in acres)</label>
          <input type="number" id="areaLocal" step="0.1" required>
        </div>
        <div class="form-group">
          <label for="expectedYieldLocal">Expected Yield (in quintals)</label>
          <input type="number" id="expectedYieldLocal" step="0.1" required>
        </div>
        <div class="form-group">
          <label for="cropNotesLocal">Additional Notes</label>
          <textarea id="cropNotesLocal" rows="3" placeholder="Any special details about your crop..."></textarea>
        </div>
        <button type="submit" class="btn save-btn">Save Crop Information</button>
      </form>

      <div style="margin-top:1.5rem;">
        <h3 style="font-size:1rem;margin-bottom:0.6rem;color:var(--text-color);">Your Saved Crops:</h3>
        <div id="cropListLocal" class="saved-crops-grid"></div>
      </div>
    </div>
  </main>

  <script>
    // Auth guard - use centralized system
    if (!GrassRootsAuth.requireAuth('farmer')) {
      // Will redirect automatically if not authorized
    }

    // TODO: Replace with API call when backend is ready
    // API Endpoint: GET /api/farmer/crops
    // Render saved crops list
    async function renderCropList() {
      // TODO: Uncomment when backend is ready
      // try {
      //   const response = await fetch('/api/farmer/crops', {
      //     headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      //   });
      //   const data = await response.json();
      //   const crops = data.crops;
      // } catch (error) {
      //   console.error('Error fetching crops:', error);
      //   GrassRootsUtils.showToast('Error loading crops', 'error');
      //   return;
      // }

      // Temporary: Load from localStorage
      const crops = GrassRootsUtils.loadFromStorage('farmerCrops', []);
      const out = document.getElementById('cropListLocal');

      if (!crops.length) {
        out.innerHTML = '<p style="color:var(--muted);">No crops added yet. Add your first crop above!</p>';
        return;
      }

      let html = '';
      crops.forEach(c => {
        const dateStr = c.plantingDate ? GrassRootsUtils.formatDate(c.plantingDate) : 'Not specified';
        html += `
          <div class="crop-card">
            <div class="crop-card-inner">
              <div class="crop-title">${GrassRootsUtils.sanitizeHTML(c.type || 'Unknown')}</div>
              <div class="crop-meta">Area: ${c.area || '‚Äî'} acres | Yield: ${c.expectedYield || '‚Äî'} qt</div>
              <div class="crop-date">Planted: ${dateStr}</div>
              ${c.notes ? `<div class="crop-notes">${GrassRootsUtils.sanitizeHTML(c.notes)}</div>` : ''}
            </div>
          </div>
        `;
      });
      out.innerHTML = html;
    }

    // TODO: Replace with API call when backend is ready
    // API Endpoint: POST /api/farmer/crops
    // Handle form submission
    document.getElementById('cropInfoFormLocal').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Get form values
      const cropData = {
        crop_type: document.getElementById('cropTypeLocal').value,
        planting_date: document.getElementById('plantingDateLocal').value,
        area_acres: parseFloat(document.getElementById('areaLocal').value),
        expected_yield_quintals: parseFloat(document.getElementById('expectedYieldLocal').value),
        notes: document.getElementById('cropNotesLocal').value
      };

      // TODO: Uncomment when backend is ready
      // try {
      //   const response = await fetch('/api/farmer/crops', {
      //     method: 'POST',
      //     headers: {
      //       'Content-Type': 'application/json',
      //       'Authorization': 'Bearer ' + localStorage.getItem('token')
      //     },
      //     body: JSON.stringify(cropData)
      //   });
      //   const data = await response.json();
      //   if (!data.success) throw new Error(data.error);
      //   GrassRootsUtils.showToast('Crop saved to database!', 'success');
      // } catch (error) {
      //   console.error('Error saving crop:', error);
      //   GrassRootsUtils.showToast('Error saving crop', 'error');
      //   return;
      // }

      // Temporary: Save to localStorage
      const crop = {
        id: GrassRootsUtils.generateId(),
        type: cropData.crop_type,
        plantingDate: cropData.planting_date,
        area: cropData.area_acres,
        expectedYield: cropData.expected_yield_quintals,
        notes: cropData.notes,
        createdAt: new Date().toISOString()
      };

      let crops = GrassRootsUtils.loadFromStorage('farmerCrops', []);
      crops.push(crop);
      GrassRootsUtils.saveToStorage('farmerCrops', crops);

      // Show success feedback
      const btn = document.querySelector('.save-btn');
      const originalText = btn.textContent;
      btn.textContent = 'Saved ‚úì';
      btn.style.backgroundColor = '#4caf50';

      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.backgroundColor = '';
      }, 1500);

      // Reset form and update list
      this.reset();
      await renderCropList();

      // Show toast notification
      GrassRootsUtils.showToast('Crop information saved successfully!', 'success');
    });

    // Initial render
    renderCropList();
  </script>
</body>
</html>