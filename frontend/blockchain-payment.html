<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blockchain Payment - GrassRoots</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      background: linear-gradient(135deg, #e8f5f0 0%, #f0f9f5 25%, #e3f2ed 50%, #d8ede5 75%, #e8f5f0 100%);
      background-attachment: fixed;
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }
    
    .payment-container {
      max-width: 800px;
      margin: 100px auto 40px;
      padding: 0 20px;
    }
    
    .payment-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(47, 107, 80, 0.15);
    }
    
    .payment-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .payment-icon {
      font-size: 60px;
      margin-bottom: 15px;
    }
    
    .payment-title {
      font-size: 32px;
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .payment-subtitle {
      color: var(--text-color);
      opacity: 0.7;
    }
    
    .order-details {
      background: var(--accent-cream);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(47, 107, 80, 0.1);
    }
    
    .detail-row:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 1.2em;
      color: var(--primary-color);
    }
    
    .wallet-section {
      margin-bottom: 30px;
    }
    
    .wallet-info {
      background: linear-gradient(135deg, #2f6b50 0%, #4a9d6f 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .wallet-address {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      word-break: break-all;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #2f6b50 0%, #4a9d6f 100%);
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(47, 107, 80, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: white;
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: var(--accent-cream);
    }
    
    .notification {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      max-width: 400px;
    }
    
    .notification-success {
      border-left: 4px solid #4a9d6f;
    }
    
    .notification-error {
      border-left: 4px solid #ef4444;
    }
    
    .notification-info {
      border-left: 4px solid #3b82f6;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container container">
      <a href="index.html" class="logo">GrassRoots</a>
      <div class="nav-links">
        <a href="retailer-dashboard.html">Dashboard</a>
        <a href="retailer-products.html">Products</a>
        <a href="retailer-orders.html">Orders</a>
        <a href="retailer-payments.html">Payments</a>
        <a href="retailer-profile.html">Profile</a>
      </div>
    </div>
  </nav>

  <!-- Notification -->
  <div id="notification" style="display: none;"></div>

  <!-- Payment Container -->
  <div class="payment-container">
    <div class="payment-card">
      <div class="payment-header">
        <div class="payment-icon">üîê</div>
        <h1 class="payment-title">Blockchain Payment</h1>
        <p class="payment-subtitle">Secure payment using Ethereum blockchain</p>
      </div>

      <!-- Order Details -->
      <div class="order-details">
        <h3 style="margin-bottom: 15px; color: var(--primary-color);">Order Details</h3>
        <div class="detail-row">
          <span>Order ID:</span>
          <span id="orderId">-</span>
        </div>
        <div class="detail-row">
          <span>Amount (INR):</span>
          <span id="amountINR">‚Çπ 0.00</span>
        </div>
        <div class="detail-row">
          <span>Amount (ETH):</span>
          <span id="amountETH">0.000000 ETH</span>
        </div>
        <div class="detail-row">
          <span>Total to Pay:</span>
          <span id="totalETH">0.000000 ETH</span>
        </div>
      </div>

      <!-- Wallet Section -->
      <div class="wallet-section" id="walletSection" style="display: none;">
        <div class="wallet-info">
          <div style="margin-bottom: 10px;">
            <strong>Connected Wallet</strong>
          </div>
          <div class="wallet-address" id="walletAddress">-</div>
          <div style="margin-top: 10px; font-size: 14px;">
            Balance: <span id="walletBalance">0.0000</span> ETH
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div id="connectSection">
        <button class="btn-primary" id="connectBtn" onclick="connectWallet()">
          Connect Wallet
        </button>
      </div>

      <div id="paymentSection" style="display: none;">
        <button class="btn-primary" id="payBtn" onclick="processPayment()">
          <span id="payBtnText">üí≥ Pay with Blockchain</span>
        </button>
        <button class="btn-secondary" onclick="cancelPayment()">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // Get order details from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId');
    const amountINR = parseFloat(urlParams.get('amount') || 0);

    // Conversion rate: 1 ETH = 200,000 INR (for demo purposes)
    const ETH_TO_INR = 200000;
    const amountETH = (amountINR / ETH_TO_INR).toFixed(6);

    // Contract configuration
    const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; // Update after deployment
    const RPC_URL = "http://127.0.0.1:8545";

    // Simple payment contract ABI (just the deposit function)
    const CONTRACT_ABI = [
      {
        "inputs": [
          { "internalType": "address", "name": "_recipient", "type": "address" },
          { "internalType": "uint256", "name": "_unlockTime", "type": "uint256" }
        ],
        "name": "deposit",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      }
    ];

    let provider = null;
    let signer = null;
    let userAddress = null;

    // Display order details
    document.getElementById('orderId').textContent = orderId || 'N/A';
    document.getElementById('amountINR').textContent = `‚Çπ ${amountINR.toFixed(2)}`;
    document.getElementById('amountETH').textContent = `${amountETH} ETH`;
    document.getElementById('totalETH').textContent = `${amountETH} ETH`;

    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      notification.style.display = 'block';

      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    async function connectWallet() {
      try {
        if (!window.ethereum) {
          showNotification('Please install MetaMask to continue', 'error');
          return;
        }

        const connectBtn = document.getElementById('connectBtn');
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="spinner"></span>Connecting...';

        // Request account access
        await window.ethereum.request({ method: 'eth_requestAccounts' });

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        // Get balance
        const balance = await provider.getBalance(userAddress);
        const balanceETH = ethers.utils.formatEther(balance);

        // Update UI
        document.getElementById('walletAddress').textContent = userAddress;
        document.getElementById('walletBalance').textContent = parseFloat(balanceETH).toFixed(4);
        document.getElementById('walletSection').style.display = 'block';
        document.getElementById('connectSection').style.display = 'none';
        document.getElementById('paymentSection').style.display = 'block';

        showNotification('Wallet connected successfully!', 'success');
      } catch (error) {
        console.error('Connection error:', error);
        showNotification('Failed to connect wallet: ' + error.message, 'error');
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('connectBtn').textContent = 'Connect Wallet';
      }
    }

    async function processPayment() {
      try {
        const payBtn = document.getElementById('payBtn');
        payBtn.disabled = true;
        payBtn.innerHTML = '<span class="spinner"></span>Processing Payment...';

        showNotification('Initiating blockchain transaction...', 'info');

        // Create contract instance
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        // Set unlock time to 1 minute from now (for demo purposes)
        const unlockTime = Math.floor(Date.now() / 1000) + 60;

        // Send transaction
        const tx = await contract.deposit(userAddress, unlockTime, {
          value: ethers.utils.parseEther(amountETH)
        });

        showNotification('Transaction submitted! Waiting for confirmation...', 'info');

        // Wait for transaction to be mined
        await tx.wait();

        showNotification('Payment successful!', 'success');

        // Mark order as paid and redirect back
        setTimeout(() => {
          markOrderAsPaid();
        }, 2000);

      } catch (error) {
        console.error('Payment error:', error);
        showNotification('Payment failed: ' + (error.message || error), 'error');

        const payBtn = document.getElementById('payBtn');
        payBtn.disabled = false;
        payBtn.innerHTML = '<span id="payBtnText">üí≥ Pay with Blockchain</span>';
      }
    }

    function markOrderAsPaid() {
      // Update order status in localStorage
      const KEY_ORDERS = 'retailer_orders';

      if (window.location.protocol === 'file:') {
        try {
          const orders = JSON.parse(localStorage.getItem(KEY_ORDERS) || '[]');
          const order = orders.find(o => o.id === orderId);

          if (order) {
            order.paid = true;
            localStorage.setItem(KEY_ORDERS, JSON.stringify(orders));
          }
        } catch (e) {
          console.error('Failed to update order:', e);
        }
      }

      // Redirect back to payments page
      window.location.href = 'retailer-payments.html?payment=success&orderId=' + orderId;
    }

    function cancelPayment() {
      if (confirm('Are you sure you want to cancel this payment?')) {
        window.location.href = 'retailer-payments.html';
      }
    }

    // Check if order ID is provided
    if (!orderId || !amountINR) {
      showNotification('Invalid payment request. Missing order details.', 'error');
      setTimeout(() => {
        window.location.href = 'retailer-payments.html';
      }, 3000);
    }
  </script>
</body>
</html>


