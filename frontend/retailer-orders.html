<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Retailer Orders - GrassRoots</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee}
    .btn{background:var(--primary-color);color:#fff;padding:8px 12px;border-radius:8px;border:none}
    body { background: #ecf5ee; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial }
    .page-wrapper { display:flex; justify-content:center; padding:80px 16px 40px 16px; min-height:100vh }
    .card { width:100%; max-width:960px; background: #fff; border-radius:10px; padding:24px 28px; box-shadow: 0 10px 30px rgba(0,0,0,0.06) }
    .card h1 { margin-top:0; color: #2f6b50 }
    .muted { color:#6b7b6b; margin-top:6px }
  </style>
</head>
<body>
  <nav class="navbar"><div class="nav-container container"><a href="index.html" class="logo">GrassRoots</a><div class="nav-links"><a href="retailer-dashboard.html">Dashboard</a><a href="retailer-products.html">Products</a><a href="retailer-payments.html">Payments</a><a href="retailer-profile.html">Profile</a></div></div></nav>

  <div class="page-wrapper">
    <div class="card">
      <h1>Orders</h1>
      <p class="muted">View and manage incoming orders.</p>
      <table id="ordersTable"><thead><tr><th>Order ID</th><th>Items</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
  <script>
    // Use backend APIs for orders and products
    async function loadOrders() {
      try {
        const resp = await fetch('/api/orders');
        if (!resp.ok) throw new Error('Failed to load orders');
        return await resp.json();
      } catch (err) {
        console.warn('Failed to fetch orders from server, falling back to localStorage', err);
        const o = JSON.parse(localStorage.getItem('retailer_orders') || '[]');
        return o;
      }
    }

    async function loadProducts() {
      try {
        const resp = await fetch('/api/products');
        if (!resp.ok) throw new Error('Failed to load products');
        return await resp.json();
      } catch (err) {
        console.warn('Failed to fetch products from server, falling back to localStorage', err);
        return JSON.parse(localStorage.getItem('retailer_products') || '[]');
      }
    }

    async function render() {
      const rows = document.querySelector('#ordersTable tbody');
      rows.innerHTML = '';
      const orders = await loadOrders();
      orders.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${o.id}</td><td>${o.items.map(i => i.name + ' x' + i.qty).join('<br>')}</td><td>₹ ${o.total.toFixed(2)}</td><td>${o.status}</td><td><button class='btn' onclick="view('${o.id}')">View</button></td>`;
        rows.appendChild(tr);
      });
    }

    async function seed() {
      const existing = await loadOrders();
      if (existing.length) return;
      const prods = await loadProducts();
      const sample = [{
        id: 'o_' + Date.now(),
        items: prods.slice(0, 2).map(p => ({ productId: p.id, name: p.name, qty: 1, price: p.price })),
        total: prods.slice(0, 2).reduce((s, p) => s + (p.price || 0), 0),
        status: 'Pending',
        paid: false
      }];
      try {
        for (const o of sample) {
          await fetch('/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(o) });
        }
        alert('Sample order seeded');
        await render();
      } catch (err) {
        console.error('Failed to seed orders:', err);
        localStorage.setItem('retailer_orders', JSON.stringify(sample));
        alert('Seeded locally');
        await render();
      }
    }

    async function view(id) {
      try {
        const resp = await fetch(`/api/orders/${id}`);
        if (!resp.ok) throw new Error('Order not found');
        const data = await resp.json();
        const o = data.order || data;
        const details = `Order ${o.id}\nItems:\n${(data.items || o.items).map(i => i.name + ' x' + i.qty).join('\n')}\nTotal: ₹ ${o.total.toFixed(2)}\nStatus: ${o.status}\nPaid: ${o.paid ? 'Yes' : 'No'}`;
        if (confirm(details + '\n\nMark Confirmed?')) {
          updateStatus(id, 'Confirmed');
        }
      } catch (err) {
        console.error('Failed to load order:', err);
      }
    }

    async function updateStatus(id, status) {
      try {
        // Update order status on server
        const resp = await fetch(`/api/orders/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
        if (!resp.ok) throw new Error('Failed to update order');

        if (status === 'Confirmed') {
          // decrement product stock for each order item
          const resp2 = await fetch(`/api/orders/${id}`);
          if (resp2.ok) {
            const data = await resp2.json();
            const items = data.items || data.order && data.order.items || [];
            for (const it of items) {
              try {
                // fetch product
                const pResp = await fetch(`/api/products/${it.productId}`);
                if (!pResp.ok) continue;
                const p = await pResp.json();
                const newStock = Math.max(0, (p.stock || 0) - (it.qty || 0));
                await fetch(`/api/products/${p.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ stock: newStock }) });
              } catch (e) {
                console.warn('Failed to update product stock for', it.productId, e);
              }
            }
          }
        }

        await render();
        alert('Status updated');
      } catch (err) {
        console.error('Failed to update status:', err);
        alert('Failed to update status');
      }
    }

    document.addEventListener('DOMContentLoaded', function() { render(); seed(); });
  </script>
</body>
</html>
